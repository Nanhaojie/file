{% extends 'base.html' %}

{% load staticfiles %}

{% block title %}文件管理 - 首页{% endblock %}

{% block custome_css %}{% endblock %}

{% block content %}
    <div class="content">
        <p>文件列表</p>
        <br/><br/>

        <table class="table-list">
            <thead>
                <tr>
                    <th>序号</th>
<!--                    <th>文件编号</th>-->
                    <th>文件名称</th>
<!--                    <th>上传用户</th>-->
                    <th>上传时间</th>
                    <th>付费状态</th>
                    <th>备注</th>
                    <th>下载</th>
                </tr>
            </thead>
            <tbody>
                {% for content in p_contents.object_list %}
                    <tr>
                        <td height=100px>{{ forloop.counter|add:start }}</td>
<!--                        <td>{{ content.fileno }}</td>-->
                        <td height=100px>{{ content.filename }}</td>
<!--                        <td>{{ content.owner }}</td>-->
                        <td height=100px>{{ content.add_time|date:"Y-m-d H:i:s" }}</td>
                        <td height=100px><a href="{% url 'files:pay' content.id %}">{{ content.get_first_check_display }}</a></td>
                        <td height=100px id="{{ content.id }}">
                            <div style="height: 100%;" onclick="handleEditRemark('{{content.id}}')">
                                {% if content.remark %}
                                    {{ content.remark }}
                                {% endif %}
                            </div>
                        </td>
                        <td height=100px><a href="{% url 'files:download' content.id %}">Download</a></td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="page">
            <ul class="pagination">
                {% if p_contents.has_previous %}
                    <li><a href="?{{ p_contents.previous_page_number.querystring }}">&laquo;</a></li>
                {% endif %}
                {% for page in p_contents.pages %}
                    {% if page %}
                        {% ifequal page p_contents.number %}
                            <li class="active"><a href="?{{ page.querystring }}">{{ page }}</a></li>
                        {% else %}
                            <li><a href="?{{ page.querystring }}">{{ page }}</a></li>
                        {% endifequal %}
                    {% else %}
                        <li>...</li>
                    {% endif %}
                {% endfor %}
                {% if p_contents.has_next %}
                    <li><a href="?{{ p_contents.next_page_number.querystring }}">&raquo;</a></li>
                {% endif %}
            </ul>
        </div>
    </div>
{% endblock %}

{% block custome_js %}
    <script>
        var btn_upload = document.getElementById("btn_upload");
        btn_upload.onclick = function () {
            location.href = "{% url 'files:upload' %}";
        };

        var btn_export = document.getElementById("btn_export");
        btn_export.onclick = function() {
            var search = document.getElementById("search").value;
            var url = "{% url 'files:export' %}";
            location.href = url + '?search=' + search;
        }

        function handleEditRemark(id) {
            const dom = document.getElementById(id)
            console.log(dom)
            dom.innerHTML = `<input id="input-${id}" onblur="handleInputBlur('${id}')"/>`
        }

        async function handleInputBlur(id) {
            const dom = document.getElementById(id)
            const inputDom = document.getElementById(`input-${id}`)
            const content = inputDom.value
            console.log(content)
            // 请求接口代码
            const res = await $.post('files/remark/', {id, content })
            if(res.data.code === 200) {
                dom.innerHTML = `<div style="height: 100%;" onclick="handleEditRemark('${id}')">
                                content
                            </div>`
            }
        }
    </script>
{% endblock %}
